# Supervised_ML: Training a CNN to classify galaxy images into 'barred' and 'non-barred' galaxies. 

This code begins by cleaning the training galaxy images of any nan values. These images are taken from the catalog, gz_decals_volunteers_1_and_2.csv found here: https://zenodo.org/records/4573248. The images were then plotted in order to check how 'good' they were in terms of barred and unbarred galaxies. At first glance, images seemed to be quite bad, with some galaxies being very faint or just badly resolved. I tried cleaning this data with different column criterias, however nothing seemed to remove the images drastically so the only criteria used was the 'yes_bar_fraction' and 'no_bar_fraction', which was set to 0.8 and above for barred and unbarred galaxies respectively. The data was then scaled and split (for both barred and unbarred images) into train, test, and validation folders by 20%. The dataset was then constructed, with an additional augmentation for barred galaxies, in all train, test, and validation datatsets. This was done because otherwise, the dataset would be unbalanced and the model would not be able to classify any barred galaxies. At first I only augmented the training dataset, however this would still not allow for the model to detect any barred galaxies, so I then decided to augment test and validation as well, which then allowed for my model to work. 

The dataset was then loaded. The number of barred and unbarred galaxies were checked to make sure that each classification was as balanced as could be. For the model, I tried three different optimizers and found the Adam optimizer to work best. I then set the metrics to accuracy, as the dataset was reasonably balanced. The loss was then set to 'sparse_categorical_crossentropy'. At first I tried 'binary_crossentropy' as we were using a binary labeled dataset. I then created a model with sigmoid activation, however this model turned out to only classify barred galaxies, even when trying to adjust the training and architecture of the model. Which is why I then changed to the 'sparse_categorical_crossentropy' and softmax activation for the model. 

The sequential model consists of three convolutional layers. The first one has 32 filters, of 3x3 pixels with a ReLU activation. Then a MaxPooling layer is placed to reduce the image by half. A second convolutional layer was placed with 64 filters in order to learn more complex features. Then another MaxPooling layer to reduce the image again. And finally a third convolutional layer with now 128 filters to go even deeper, with a final MaxPooling layer. The Flatten layer was added in order to convert the 2Dmaps into a 1D vector. Then a dense layer with 128 neurons was placed with ReLU activation in order to connect the neurons to the previous layer. Finally, a dense output layer was added for the distribution into the two different classes: barred or unbarred.  

This model was trained with an initial 100 epochs. Two callbacks were used, a ModelCheckpoint to save the best weights and model during the training, based on how well the validation accuracy is going. The EarlyStopping in order to stop the training when the validation loss is at its lowest, such that when it starts to overfit the training stops. The training model stops very early and has very high validation accuracy and loss, which is surprising. I tried fixing this issue for a while by trying other models with more/less layers, including dropouts to fix overfitting, however this then caused the model to be unable to detect barred galaxies, or on the other hand to detect unbarred galaxies. After spending way too much time, and no other CNN or change in training helping with the overall predictions, I decided to continue with this model since it could at least find some predictions in both barred and unbarred galaxies. 

The training data is being used on a mean redshift of 0.08. If I were to apply a higher redshift on top of the current one, the appearance of these galaxies at higher redshift would change, giving more variation in the training set and a more unbiased training for the model, assuming the labels are correct and the redshifts are balanced. If only applying a higher redshift, then the model would be biased to only this redshift, as it was to when we trained it on a redshift of 0.08. 

When running it for at least 100 epochs, we see that this model is overfitting the data as the validation losses are increasing over that of the training losses. This can be fixed by increasing the amount of data, or trying to reduce the complexity of the model using dropouts or batch normalization. 

Out of the 1217 galaxies from the HSC survey (https://hsc.mtk.nao.ac.jp/ssp/), the model predicted 10 barred ones and 1207 unbarred ones. This is better than the model not finding any at all, however, compared the training data, this is a drastic difference as there were more barred galaxies than unbarred galaxies. This shows that the model still needs a lot of improvement. 

Both barred and unbarred galaxies have a mean redshift of around 0.12 and follow in trend. Barred galaxies have a slightly higher stellar mass with a mean of 1.160004e+10 solar masses and unbarred galaxies having a mean of 1.058494e+10 solar masses. Both SFRs have a mean of around 1.9, and barred galaxies have a slightly higher agn_fraction, however all of this cannot be for certain as the percentage of barred galaxies is very low and these differences are very small. 

Citations:
[1]M. Walmsley, “Galaxy Zoo DECaLS: Detailed Visual Morphology Measurements from Volunteers and Deep Learning for 314,000 Galaxies”. Zenodo, Dec. 29, 2020. doi: 10.5281/zenodo.4573248.